(window.webpackJsonp=window.webpackJsonp||[]).push([[134],{207:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return i})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var o=t(3),r=t(7),a=(t(0),t(265)),i={title:"Controladores y Hooks de Autentificaci\xf3n"},s={unversionedId:"tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",id:"tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",isDocsHomePage:!1,title:"Controladores y Hooks de Autentificaci\xf3n",description:"Hasta ahora, ha definido el modelo Usuario y ha escrito un script para crear nuevos usuarios con su contrase\xf1a y direcci\xf3n de correo electr\xf3nico. El siguiente paso es crear un controlador para que los usuarios puedan connectarse.",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks.md",slug:"/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",permalink:"/es/docs/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",editUrl:"https://github.com/FoalTS/foal/edit/master/docs/i18n/es/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks.md",version:"current",sidebar:"someSidebar",previous:{title:"Los Scripts Shell",permalink:"/es/docs/tutorials/multi-user-todo-list/3-the-shell-scripts"},next:{title:"Tareas & Propriedad",permalink:"/es/docs/tutorials/multi-user-todo-list/6-todos-and-ownership"}},l=[{value:"Las P\xe1ginas de Inicio de Sesi\xf3n y Principal",id:"las-p\xe1ginas-de-inicio-de-sesi\xf3n-y-principal",children:[]},{value:"Controladores de Conexi\xf3n",id:"controladores-de-conexi\xf3n",children:[]},{value:"Control de Acceso",id:"control-de-acceso",children:[]}],c={toc:l};function p(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(a.b)("wrapper",Object(o.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Hasta ahora, ha definido el modelo ",Object(a.b)("inlineCode",{parentName:"p"},"Usuario")," y ha escrito un script para crear nuevos usuarios con su contrase\xf1a y direcci\xf3n de correo electr\xf3nico. El siguiente paso es crear un controlador para que los usuarios puedan connectarse."),Object(a.b)("p",null,"Esta es la arquitectura que queremos:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Los usuarios abren la p\xe1gina ",Object(a.b)("inlineCode",{parentName:"li"},"/signin"),", introducen sus credenciales y luego son redirigidos a la p\xe1gina ",Object(a.b)("inlineCode",{parentName:"li"},"/")," si las credenciales son correctas. Si no lo son, la p\xe1gina se actualiza con un mensaje de error."),Object(a.b)("li",{parentName:"ol"},"Los usuarios pueden ver, crear y eliminar sus temas en la p\xe1gina ",Object(a.b)("inlineCode",{parentName:"li"},"/"),"."),Object(a.b)("li",{parentName:"ol"},"Cuando pulsan el bot\xf3n ",Object(a.b)("inlineCode",{parentName:"li"},"Log out"),", se desconectan y son redirigidos a la p\xe1gina ",Object(a.b)("inlineCode",{parentName:"li"},"/signin"),".")),Object(a.b)("p",null,"Cuando el usuario pulsa el bot\xf3n ",Object(a.b)("inlineCode",{parentName:"p"},"Log in")," en la p\xe1gina de inicio de sesi\xf3n, la p\xe1gina solicita ",Object(a.b)("inlineCode",{parentName:"p"},"POST /auth/login")," con las credenciales como cuerpo."),Object(a.b)("p",null,"Cuando el usuario pulsa el bot\xf3n ",Object(a.b)("inlineCode",{parentName:"p"},"Log out")," en la p\xe1gina de lista de tareas, la p\xe1gina solicita ",Object(a.b)("inlineCode",{parentName:"p"},"POST /auth/logout"),"."),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"En este escenario, el proceso de autenticaci\xf3n se maneja con sesiones y redirecciones http. No se utilizar\xe1n ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/JSON_Web_Token#Use"}),"tokens JWT")," que a veces se utilizan en las aplicaciones de una sola p\xe1gina (",Object(a.b)("em",{parentName:"p"},"Single Page Applications")," o ",Object(a.b)("em",{parentName:"p"},"SPA"),").")),Object(a.b)("h2",{id:"las-p\xe1ginas-de-inicio-de-sesi\xf3n-y-principal"},"Las P\xe1ginas de Inicio de Sesi\xf3n y Principal"),Object(a.b)("p",null,"Descargue los archivos html, css y js pulsando ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://foalts.org/multi-user-todo-list-v2.zip"}),"aqu\xed"),"."),Object(a.b)("p",null,"Vac\xede el directorio ",Object(a.b)("inlineCode",{parentName:"p"},"public/"),"."),Object(a.b)("p",null,"Luego mueva ",Object(a.b)("inlineCode",{parentName:"p"},"script.js")," y ",Object(a.b)("inlineCode",{parentName:"p"},"style.css")," a ",Object(a.b)("inlineCode",{parentName:"p"},"public/")," y los archivos ",Object(a.b)("inlineCode",{parentName:"p"},"index.html"),", ",Object(a.b)("inlineCode",{parentName:"p"},"signin.html")," y ",Object(a.b)("inlineCode",{parentName:"p"},"signup.html")," a un nuevo directorio ",Object(a.b)("inlineCode",{parentName:"p"},"templates/")," en la ra\xedz de su proyecto."),Object(a.b)("p",null,"Abra el archivo ",Object(a.b)("inlineCode",{parentName:"p"},"app.controller.ts")," y a\xf1ada tres nuevas rutas para servir las p\xe1ginas."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, controller, Get, IAppController, render, Session, UseSessions } from '@foal/core';\nimport { fetchUser } from '@foal/typeorm';\nimport { createConnection } from 'typeorm';\n\nimport { ApiController } from './controllers';\nimport { User } from './entities';\n\n@UseSessions({\n  cookie: true,\n  user: fetchUser(User)\n})\nexport class AppController implements IAppController {\n  subControllers = [\n    controller('/api', ApiController)\n  ];\n\n  async init() {\n    await createConnection();\n  }\n\n  @Get('/')\n  index() {\n    return render('templates/index.html');\n  }\n\n  @Get('/signin')\n  signin(ctx: Context<any, Session>) {\n    return render('templates/signin.html', { error: ctx.session.get('error', '') });\n  }\n  \n  @Get('/signup')\n  signup(ctx: Context<any, Session>) {\n    return render('templates/signup.html', { error: ctx.session.get('error', '') });\n  }\n}\n")),Object(a.b)("p",null,"Abra su navegador y vaya a ",Object(a.b)("inlineCode",{parentName:"p"},"http://localhost:3001/signin"),". Deber\xeda aparecer la p\xe1gina de inicio de sesi\xf3n."),Object(a.b)("h2",{id:"controladores-de-conexi\xf3n"},"Controladores de Conexi\xf3n"),Object(a.b)("p",null,"El siguiente paso es crear un controlador que conecte a los usuarios y los redirija despu\xe9s de que la operaci\xf3n tenga \xe9xito o falle. Necesita dos rutas ",Object(a.b)("inlineCode",{parentName:"p"},"/login")," y ",Object(a.b)("inlineCode",{parentName:"p"},"/logout"),"."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{}),"foal generate controller auth --register\n")),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"La bandera ",Object(a.b)("inlineCode",{parentName:"p"},"--register")," a\xf1ade directamente una nueva l\xednea en ",Object(a.b)("inlineCode",{parentName:"p"},"app.controller.ts")," para declarar el ",Object(a.b)("inlineCode",{parentName:"p"},"AuthController")," como un subcontrolador de ",Object(a.b)("inlineCode",{parentName:"p"},"AppController"),".")),Object(a.b)("p",null,"Abra el nuevo archivo ",Object(a.b)("inlineCode",{parentName:"p"},"auth.controller.ts")," y reemplace su contenido."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"// 3p\nimport {\n  Context, dependency, HttpResponseRedirect, Post, Session,\n  Store, ValidateBody, verifyPassword\n} from '@foal/core';\n\nimport { User } from '../entities';\n\nexport class AuthController {\n  // This line is required.\n  @dependency\n  store: Store;\n\n  @Post('/login')\n  // Validate the request body.\n  @ValidateBody({\n    additionalProperties: false,\n    properties: {\n        email: { type: 'string', format: 'email' },\n        password: { type: 'string' }\n    },\n    required: ['email', 'password'],\n    type: 'object',\n  })\n  async login(ctx: Context<User, Session>) {\n    const user = await User.findOne({ email: ctx.request.body.email });\n\n    if (!user) {\n      // Redirect the user to /signin if the authentication fails.\n      ctx.session.set('error', 'Invalid email or password.', { flash: true });\n      return new HttpResponseRedirect('/signin');\n    }\n\n    if (!await verifyPassword(ctx.request.body.password, user.password)) {\n      // Redirect the user to /signin if the authentication fails.\n      ctx.session.set('error', 'Invalid email or password.', { flash: true });\n      return new HttpResponseRedirect('/signin');\n    }\n\n    // Associate the current session with the authenticated user.\n    ctx.session.setUser(user);\n\n    // Redirect the user to the home page on success.\n    return new HttpResponseRedirect('/');\n  }\n\n  @Post('/logout')\n  async logout(ctx: Context) {\n    // Destroy the user session.\n    if (ctx.session) {\n      await ctx.session.destroy();\n    }\n\n    // Redirect the user to the home page on success.\n    return new HttpResponseRedirect('/signin');\n  }\n}\n\n")),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"Escribir ",Object(a.b)("inlineCode",{parentName:"p"},"User.findOne({ email: email, password: password })")," no puede funcionar ya que la contrase\xf1a necesita ser hash.")),Object(a.b)("p",null,"Vuelva a su navegador e intente conectarse con el correo electr\xf3nico ",Object(a.b)("inlineCode",{parentName:"p"},"john@foalts.org")," y la contrase\xf1a ",Object(a.b)("inlineCode",{parentName:"p"},"mary_password"),". Se le redirige a la misma p\xe1gina y aparece el mensaje ",Object(a.b)("inlineCode",{parentName:"p"},"Invalid email or password."),". Ahora utilice la contrase\xf1a ",Object(a.b)("inlineCode",{parentName:"p"},"john_password")," e intente conectarse. Se le redirige a la p\xe1gina de tareas. Si hace clic en el bot\xf3n ",Object(a.b)("inlineCode",{parentName:"p"},"Log out")," ser\xe1 redirigido a la p\xe1gina de inicio de sesi\xf3n."),Object(a.b)("h2",{id:"control-de-acceso"},"Control de Acceso"),Object(a.b)("p",null,"Genial, hasta ahora puede autenticar a los usuarios. Pero como todav\xeda no ha a\xf1adido el control de acceso a la p\xe1gina de la lista de tareas y a la API, los usuarios no autentificados pueden seguir accediendo a ella."),Object(a.b)("p",null,"La forma habitual de gestionar la autorizaci\xf3n es utilizar un ",Object(a.b)("em",{parentName:"p"},"hook"),". En este caso, va a utilizar el hook incorporado ",Object(a.b)("inlineCode",{parentName:"p"},"UserRequired")," que devuelve un error 401 o redirige al usuario si \xe9ste no est\xe1 conectado. "),Object(a.b)("p",null,"Actualice ",Object(a.b)("inlineCode",{parentName:"p"},"app.controller.ts"),"."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, controller, Get, IAppController, render, Session, UserRequired, UseSessions } from '@foal/core';\n\nimport { ApiController, AuthController } from './controllers';\n\n// ...\nexport class AppController extends IAppController {\n\n  // ...\n\n  @Get('/')\n  @UserRequired({\n    // Redirect to /signin if the user is not authenticated.\n    redirectTo: '/signin'\n  })\n  index() {\n    // ...\n  }\n\n  // ...\n\n}\n")),Object(a.b)("p",null,"Actualice ",Object(a.b)("inlineCode",{parentName:"p"},"api.controller.ts"),"."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-typescript"}),"import {\n  Context, Delete, Get, HttpResponseCreated, HttpResponseNoContent,\n  HttpResponseNotFound, HttpResponseOK, Post,\n  UserRequired, ValidateBody, ValidatePathParam\n} from '@foal/core';\n\nimport { Todo, User } from '../entities';\n\n@UserRequired()\nexport class ApiController {\n\n  ...\n\n}\n")),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"Cuando un hook decora una clase de controlador, se aplica a todas las rutas del controlador y sus subcontroladores.")),Object(a.b)("p",null,"Vaya a ",Object(a.b)("inlineCode",{parentName:"p"},"http://localhost:3001"),". Si no est\xe1 conectado, deber\xeda ser redirigido a la p\xe1gina de acceso."))}p.isMDXComponent=!0},265:function(e,n,t){"use strict";t.d(n,"a",(function(){return u})),t.d(n,"b",(function(){return m}));var o=t(0),r=t.n(o);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=r.a.createContext({}),p=function(e){var n=r.a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=p(e.components);return r.a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},b=r.a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(t),b=o,m=u["".concat(i,".").concat(b)]||u[b]||d[b]||a;return t?r.a.createElement(m,s(s({ref:n},c),{},{components:t})):r.a.createElement(m,s({ref:n},c))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=b;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=t[c];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,t)}b.displayName="MDXCreateElement"}}]);
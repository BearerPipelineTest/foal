(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{242:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return l})),t.d(n,"metadata",(function(){return i})),t.d(n,"toc",(function(){return c})),t.d(n,"default",(function(){return u}));var a=t(3),r=t(7),o=(t(0),t(283)),l={title:"Autenticaci\xf3n Social con Google"},i={unversionedId:"tutorials/real-world-example-with-react/15-social-auth",id:"tutorials/real-world-example-with-react/15-social-auth",isDocsHomePage:!1,title:"Autenticaci\xf3n Social con Google",description:"En esta \xfaltima parte del tutorial, daremos a los usuarios la posibilidad de iniciar sesi\xf3n con Google. Actualmente, s\xf3lo pueden iniciar sesi\xf3n con un correo electr\xf3nico y una contrase\xf1a.",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/tutorials/real-world-example-with-react/15-social-auth.md",slug:"/tutorials/real-world-example-with-react/15-social-auth",permalink:"/es/docs/tutorials/real-world-example-with-react/15-social-auth",editUrl:"https://github.com/FoalTS/foal/edit/master/docs/i18n/es/docusaurus-plugin-content-docs/current/tutorials/real-world-example-with-react/15-social-auth.md",version:"current",sidebar:"someSidebar",previous:{title:"Construcci\xf3n de Producci\xf3n",permalink:"/es/docs/tutorials/real-world-example-with-react/14-production-build"},next:{title:"Arquitectura",permalink:"/es/docs/architecture/architecture-overview"}},c=[{value:"Contrase\xf1as anulables",id:"contrase\xf1as-anulables",children:[]},{value:"Configuraci\xf3n",id:"configuraci\xf3n",children:[]},{value:"El controlador social",id:"el-controlador-social",children:[]}],s={toc:c};function u(e){var n=e.components,l=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,l,{components:n,mdxType:"MDXLayout"}),Object(o.b)("p",null,"En esta \xfaltima parte del tutorial, daremos a los usuarios la posibilidad de iniciar sesi\xf3n con Google. Actualmente, s\xf3lo pueden iniciar sesi\xf3n con un correo electr\xf3nico y una contrase\xf1a."),Object(o.b)("p",null,"Para ello, utilizar\xe1 el sistema de autenticaci\xf3n social de Foal."),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},Object(o.b)("em",{parentName:"p"},"Esta secci\xf3n supone que ya ha configurado una aplicaci\xf3n de Google y ha recuperado su ID de cliente y su secreto. Si no lo ha hecho, es posible que quiera consultar primero esta ",Object(o.b)("a",Object(a.a)({parentName:"em"},{href:"/es/docs/authentication-and-access-control/social-auth"}),"p\xe1gina"),". Los URI de redirecci\xf3n permitidos en su aplicaci\xf3n de Google deben incluir ",Object(o.b)("inlineCode",{parentName:"em"},"http://localhost:3001/api/auth/google/callback"),"."))),Object(o.b)("h2",{id:"contrase\xf1as-anulables"},"Contrase\xf1as anulables"),Object(o.b)("p",null,"El primer paso es actualizar el modelo ",Object(o.b)("inlineCode",{parentName:"p"},"User"),". Es posible que algunos usuarios s\xf3lo utilicen el inicio de sesi\xf3n social y, por lo tanto, no tengan una contrase\xf1a. Para tener esto en cuenta, haremos que la columna ",Object(o.b)("inlineCode",{parentName:"p"},"password")," acepte valores nulos."),Object(o.b)("p",null,"Abra ",Object(o.b)("inlineCode",{parentName:"p"},"user.entity.ts")," y actualice su contenido."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"import { BaseEntity, Column, Entity, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class User extends BaseEntity {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column({ unique: true })\n  email: string;\n\n  @Column({ nullable: true })\n  password: string;\n\n  @Column()\n  name: string;\n\n  @Column()\n  avatar: string;\n\n}\n\nexport { DatabaseSession } from '@foal/typeorm';\n")),Object(o.b)("p",null,"Realice y ejecute las migraciones."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"npm run makemigrations\nnpm run migrations\n")),Object(o.b)("p",null,"A continuaci\xf3n, abra ",Object(o.b)("inlineCode",{parentName:"p"},"auth.controller.ts")," y a\xf1ada una condici\xf3n para comprobar si el valor de la contrase\xf1a es ",Object(o.b)("inlineCode",{parentName:"p"},"null")," en la base de datos."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"if (!user.password) {\n  return new HttpResponseUnauthorized();\n}\n\nif (!(await verifyPassword(password, user.password))) {\n  return new HttpResponseUnauthorized();\n}\n")),Object(o.b)("h2",{id:"configuraci\xf3n"},"Configuraci\xf3n"),Object(o.b)("p",null,"Ahora que el problema de la contrase\xf1a est\xe1 resuelto, puede instalar los paquetes y proporcionar sus credenciales sociales en la configuraci\xf3n."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"npm install @foal/social node-fetch\n")),Object(o.b)("p",null,Object(o.b)("em",{parentName:"p"},"config/default.json")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n  "port": "env(PORT)",\n  "settings": {\n    ...\n    "social": {\n      "google": {\n        "clientId": "env(GOOGLE_CLIENT_ID)",\n        "clientSecret": "env(GOOGLE_CLIENT_SECRET)",\n        "redirectUri": "http://localhost:3001/api/auth/google/callback"\n      }\n    },\n  },\n  ...\n}\n')),Object(o.b)("p",null,Object(o.b)("em",{parentName:"p"},".env")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),'# ...\n\nGOOGLE_CLIENT_ID="your Google client ID"\nGOOGLE_CLIENT_SECRET="your Google client secret"\n')),Object(o.b)("h2",{id:"el-controlador-social"},"El controlador social"),Object(o.b)("p",null,"Cree el controlador."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"foal generate controller api/social-auth --register\n")),Object(o.b)("p",null,"Abra el archivo y a\xf1ada dos nuevas rutas."),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Punto final"),Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"M\xe9todo"),Object(o.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Descripci\xf3n"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"/api/auth/google")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"POST")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Redirige al usuario a la p\xe1gina de inicio de sesi\xf3n de Google.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"/api/auth/google/callback")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"GET")),Object(o.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Gestiona la redirecci\xf3n de Google una vez que el usuario ha aprobado la conexi\xf3n.")))),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, dependency, Get, HttpResponseRedirect, Session } from '@foal/core';\nimport { GoogleProvider } from '@foal/social';\nimport { User } from '../../entities';\nimport * as fetch from 'node-fetch';\nimport { Disk } from '@foal/storage';\n\ninterface GoogleUserInfo {\n  email: string;\n  name?: string;\n  picture?: string;\n}\n\nexport class SocialAuthController {\n  @dependency\n  google: GoogleProvider;\n\n  @dependency\n  disk: Disk;\n\n  @Get('/google')\n  redirectToGoogle() {\n    return this.google.redirect();\n  }\n\n  @Get('/google/callback')\n  async handleGoogleRedirection(ctx: Context<User, Session>) {\n    const { userInfo } = await this.google.getUserInfo<GoogleUserInfo>(ctx);\n\n    if (!userInfo.email) {\n      throw new Error('Google should have returned an email address.');\n    }\n\n    let user = await User.findOne({ email: userInfo.email });\n\n    if (!user) {\n      user = new User();\n      user.email = userInfo.email;\n      user.avatar = '';\n      user.name = userInfo.name ?? 'Unknown';\n\n      if (userInfo.picture) {\n        const response = await fetch(userInfo.picture);\n        const { path } = await this.disk.write('images/profiles/uploaded', response.body)\n        user.avatar = path;\n      }\n\n      await user.save();\n    }\n\n    ctx.session.setUser(user);\n    ctx.user = user;\n\n    return new HttpResponseRedirect('/');\n  }\n\n}\n\n")),Object(o.b)("p",null,"Abra ",Object(o.b)("inlineCode",{parentName:"p"},"api.controller.ts")," y sustituya el prefijo de la ruta del ",Object(o.b)("inlineCode",{parentName:"p"},"SocialAuthController")," por ",Object(o.b)("inlineCode",{parentName:"p"},"/auth"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"subControllers = [\n  controller('/stories', StoriesController),\n  controller('/auth', AuthController),\n  controller('/profile', ProfileController),\n  controller('/auth', SocialAuthController)\n];\n")),Object(o.b)("p",null,"Vaya a ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"http://localhost:3001/login"}),"http://localhost:3001/login")," y haga clic en el bot\xf3n ",Object(o.b)("em",{parentName:"p"},"Connect with Google"),". Ser\xe1 redirigido a la p\xe1gina de conexi\xf3n de Google. Una vez que haya validado la conexi\xf3n, ser\xe1 redirigido a la p\xe1gina de inicio. Si tiene una foto de perfil de Google, la ver\xe1 en su p\xe1gina de perfil."),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"Para que esto funcione, debe asegurarse de que est\xe1 utilizando el puerto ",Object(o.b)("inlineCode",{parentName:"p"},"3001")," para probar el inicio de sesi\xf3n social. Esto asume que usted cre\xf3 la construcci\xf3n de producci\xf3n en el paso anterior de este tutorial. No puede utilizar el servidor de desarrollo de React aqu\xed porque las redirecciones no funcionar\xe1n con ambos puertos ",Object(o.b)("inlineCode",{parentName:"p"},"3000")," y ",Object(o.b)("inlineCode",{parentName:"p"},"3001"),". ")),Object(o.b)("p",null,"\xa1Enhorabuena! Ha llegado al final de este tutorial. Puede encontrar el c\xf3digo fuente completo ",Object(o.b)("a",{target:"_blank",href:t(430).default},"aqu\xed"),"."))}u.isMDXComponent=!0},283:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return m}));var a=t(0),r=t.n(a);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=r.a.createContext({}),u=function(e){var n=r.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return r.a.createElement(s.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},d=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),p=u(t),d=a,m=p["".concat(l,".").concat(d)]||p[d]||b[d]||o;return t?r.a.createElement(m,i(i({ref:n},s),{},{components:t})):r.a.createElement(m,i({ref:n},s))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,l=new Array(o);l[0]=d;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var s=2;s<o;s++)l[s]=t[s];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},430:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/files/tutorial-foal-react-eb9413cdda30e58d7bf2efefe643b589.zip"}}]);
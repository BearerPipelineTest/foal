(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{130:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return a})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return u}));var r=n(3),o=n(7),s=(n(0),n(290)),i={title:"Contr\xf4leurs & Hooks d'Authentification"},a={unversionedId:"tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",id:"tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",isDocsHomePage:!1,title:"Contr\xf4leurs & Hooks d'Authentification",description:"Jusqu'\xe0 pr\xe9sent, vous avez d\xe9fini le mod\xe8le User et \xe9crit un script pour cr\xe9er de nouveaux utilisateurs avec leur mot de passe et leur adresse email. L'\xe9tape suivante consiste \xe0 cr\xe9er un contr\xf4leur pour connecter ou d\xe9connecter les utilisateurs.",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks.md",slug:"/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",permalink:"/fr/docs/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks",editUrl:"https://github.com/FoalTS/foal/edit/master/docs/i18n/fr/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks.md",version:"current",sidebar:"someSidebar",previous:{title:"Les Scripts Shell",permalink:"/fr/docs/tutorials/multi-user-todo-list/3-the-shell-scripts"},next:{title:"Todos & Possession",permalink:"/fr/docs/tutorials/multi-user-todo-list/6-todos-and-ownership"}},l=[{value:"Les Pages Principale et de Connexion",id:"les-pages-principale-et-de-connexion",children:[]},{value:"Contr\xf4leurs de Connexion",id:"contr\xf4leurs-de-connexion",children:[]},{value:"Contr\xf4le d&#39;acc\xe8s",id:"contr\xf4le-dacc\xe8s",children:[]}],c={toc:l};function u(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(s.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"Jusqu'\xe0 pr\xe9sent, vous avez d\xe9fini le mod\xe8le ",Object(s.b)("inlineCode",{parentName:"p"},"User")," et \xe9crit un script pour cr\xe9er de nouveaux utilisateurs avec leur mot de passe et leur adresse email. L'\xe9tape suivante consiste \xe0 cr\xe9er un contr\xf4leur pour connecter ou d\xe9connecter les utilisateurs."),Object(s.b)("p",null,"Voici l'architecture que nous voulons :"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},"Les utilisateurs ouvrent la page ",Object(s.b)("inlineCode",{parentName:"li"},"/signin"),", entrent leurs identifiants et sont ensuite redirig\xe9s vers la page ",Object(s.b)("inlineCode",{parentName:"li"},"/")," si les identifiants sont corrects. S'ils ne le sont pas, la page est rafra\xeechie avec un message d'erreur."),Object(s.b)("li",{parentName:"ol"},"Les utilisateurs peuvent voir, cr\xe9er et supprimer leurs todos sur la page ",Object(s.b)("inlineCode",{parentName:"li"},"/"),"."),Object(s.b)("li",{parentName:"ol"},"Lorsqu'ils cliquent sur le bouton ",Object(s.b)("inlineCode",{parentName:"li"},"Log out"),", ils sont d\xe9connect\xe9s et redirig\xe9s vers la page ",Object(s.b)("inlineCode",{parentName:"li"},"/signin"),".")),Object(s.b)("p",null,"Lorsque l'utilisateur appuie sur le bouton ",Object(s.b)("inlineCode",{parentName:"p"},"Log in")," dans la page de connexion, la page envoie une requ\xeate ",Object(s.b)("inlineCode",{parentName:"p"},"POST /auth/login")," avec les informations d'identification dans le corps."),Object(s.b)("p",null,"Lorsque l'utilisateur appuie sur le bouton ",Object(s.b)("inlineCode",{parentName:"p"},"Log out")," dans la page de la liste de t\xe2ches, la page envoie une requ\xeate ",Object(s.b)("inlineCode",{parentName:"p"},"POST /auth/logout"),"."),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"Dans ce sc\xe9nario, le processus d'authentification est g\xe9r\xe9 avec des sessions et des redirections HTTP. Vous n'utiliserez pas les ",Object(s.b)("a",Object(r.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/JSON_Web_Token#Use"}),"jetons JWT")," qui sont parfois utilis\xe9s dans les ",Object(s.b)("em",{parentName:"p"},"Single Page Applications")," (SPA).")),Object(s.b)("h2",{id:"les-pages-principale-et-de-connexion"},"Les Pages Principale et de Connexion"),Object(s.b)("p",null,"T\xe9l\xe9chargez les fichiers html, css et js en cliquant ",Object(s.b)("a",Object(r.a)({parentName:"p"},{href:"https://foalts.org/multi-user-todo-list-v2.zip"}),"ici"),"."),Object(s.b)("p",null,"Videz le r\xe9pertoire ",Object(s.b)("inlineCode",{parentName:"p"},"public/"),"."),Object(s.b)("p",null,"D\xe9placez ensuite les fichiers ",Object(s.b)("inlineCode",{parentName:"p"},"script.js")," et ",Object(s.b)("inlineCode",{parentName:"p"},"style.css")," vers ",Object(s.b)("inlineCode",{parentName:"p"},"public/")," et les fichiers ",Object(s.b)("inlineCode",{parentName:"p"},"index.html"),", ",Object(s.b)("inlineCode",{parentName:"p"},"signin.html")," et ",Object(s.b)("inlineCode",{parentName:"p"},"signup.html")," vers un nouveau r\xe9pertoire ",Object(s.b)("inlineCode",{parentName:"p"},"templates/")," \xe0 la racine de votre projet."),Object(s.b)("p",null,"Ouvrez le fichier ",Object(s.b)("inlineCode",{parentName:"p"},"app.controller.ts")," et ajoutez trois nouvelles routes pour servir les pages."),Object(s.b)("pre",null,Object(s.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, controller, Get, IAppController, render, Session, UseSessions } from '@foal/core';\nimport { fetchUser } from '@foal/typeorm';\nimport { createConnection } from 'typeorm';\n\nimport { ApiController } from './controllers';\nimport { User } from './entities';\n\n@UseSessions({\n  cookie: true,\n  user: fetchUser(User)\n})\nexport class AppController implements IAppController {\n  subControllers = [\n    controller('/api', ApiController)\n  ];\n\n  async init() {\n    await createConnection();\n  }\n\n  @Get('/')\n  index() {\n    return render('templates/index.html');\n  }\n\n  @Get('/signin')\n  signin(ctx: Context<any, Session>) {\n    return render('templates/signin.html', { error: ctx.session.get('error', '') });\n  }\n  \n  @Get('/signup')\n  signup(ctx: Context<any, Session>) {\n    return render('templates/signup.html', { error: ctx.session.get('error', '') });\n  }\n}\n")),Object(s.b)("p",null,"Ouvrez votre navigateur et allez sur http://localhost:3001/signin. La page de connexion devrait s'afficher."),Object(s.b)("h2",{id:"contr\xf4leurs-de-connexion"},"Contr\xf4leurs de Connexion"),Object(s.b)("p",null,"L'\xe9tape suivante consiste \xe0 cr\xe9er un contr\xf4leur qui connecte ou d\xe9connecte les utilisateurs et les redirige apr\xe8s la r\xe9ussite ou l'\xe9chec de l'op\xe9ration. Il a besoin de deux routes ",Object(s.b)("inlineCode",{parentName:"p"},"/login")," et ",Object(s.b)("inlineCode",{parentName:"p"},"/logout"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(r.a)({parentName:"pre"},{}),"foal generate controller auth --register\n")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"Le drapeau ",Object(s.b)("inlineCode",{parentName:"p"},"--register")," ajoute directement une nouvelle ligne dans ",Object(s.b)("inlineCode",{parentName:"p"},"app.controller.ts")," pour d\xe9clarer l'",Object(s.b)("inlineCode",{parentName:"p"},"AuthController")," comme un sous-contr\xf4leur de ",Object(s.b)("inlineCode",{parentName:"p"},"AppController"),".")),Object(s.b)("p",null,"Ouvrez le nouveau fichier ",Object(s.b)("inlineCode",{parentName:"p"},"auth.controller.ts")," et remplacez son contenu."),Object(s.b)("pre",null,Object(s.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"// 3p\nimport {\n  Context, dependency, HttpResponseRedirect, Post, Session,\n  Store, ValidateBody, verifyPassword\n} from '@foal/core';\n\nimport { User } from '../entities';\n\nexport class AuthController {\n  // This line is required.\n  @dependency\n  store: Store;\n\n  @Post('/login')\n  // Validate the request body.\n  @ValidateBody({\n    additionalProperties: false,\n    properties: {\n        email: { type: 'string', format: 'email' },\n        password: { type: 'string' }\n    },\n    required: ['email', 'password'],\n    type: 'object',\n  })\n  async login(ctx: Context<User, Session>) {\n    const user = await User.findOne({ email: ctx.request.body.email });\n\n    if (!user) {\n      // Redirect the user to /signin if the authentication fails.\n      ctx.session.set('error', 'Invalid email or password.', { flash: true });\n      return new HttpResponseRedirect('/signin');\n    }\n\n    if (!await verifyPassword(ctx.request.body.password, user.password)) {\n      // Redirect the user to /signin if the authentication fails.\n      ctx.session.set('error', 'Invalid email or password.', { flash: true });\n      return new HttpResponseRedirect('/signin');\n    }\n\n    // Associate the current session with the authenticated user.\n    ctx.session.setUser(user);\n\n    // Redirect the user to the home page on success.\n    return new HttpResponseRedirect('/');\n  }\n\n  @Post('/logout')\n  async logout(ctx: Context) {\n    // Destroy the user session.\n    if (ctx.session) {\n      await ctx.session.destroy();\n    }\n\n    // Redirect the user to the home page on success.\n    return new HttpResponseRedirect('/signin');\n  }\n}\n\n")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"Ecrire ",Object(s.b)("inlineCode",{parentName:"p"},"User.findOne({ email: email, password: password })")," ne peut pas fonctionner car le mot de passe doit \xeatre hach\xe9.")),Object(s.b)("p",null,"Retournez \xe0 votre navigateur et essayez de vous connecter avec l'e-mail ",Object(s.b)("inlineCode",{parentName:"p"},"john@foalts.org")," et le mot de passe ",Object(s.b)("inlineCode",{parentName:"p"},"mary_password"),". Vous \xeates redirig\xe9 vers la m\xeame page et le message ",Object(s.b)("inlineCode",{parentName:"p"},"Invalid email or password.")," appara\xeet. Utilisez maintenant le mot de passe ",Object(s.b)("inlineCode",{parentName:"p"},"john_password")," et essayez de vous connecter. Vous \xeates redirig\xe9 vers la page todo-list o\xf9 tous les todos sont r\xe9pertori\xe9s. Si vous cliquez sur le bouton ",Object(s.b)("inlineCode",{parentName:"p"},"Log out"),", vous \xeates alors redirig\xe9 vers la page de connexion !"),Object(s.b)("h2",{id:"contr\xf4le-dacc\xe8s"},"Contr\xf4le d'acc\xe8s"),Object(s.b)("p",null,"Super, jusqu'\xe0 pr\xe9sent vous pouvez authentifier les utilisateurs. Mais comme vous n'avez pas encore ajout\xe9 le contr\xf4le d'acc\xe8s \xe0 la page \"todo-list\" et \xe0 l'API, les utilisateurs non authentifi\xe9s peuvent toujours y acc\xe9der."),Object(s.b)("p",null,"La fa\xe7on habituelle de g\xe9rer les autorisations est d'utiliser un ",Object(s.b)("em",{parentName:"p"},"hook"),". Dans ce cas, vous allez utiliser le hook int\xe9gr\xe9 ",Object(s.b)("inlineCode",{parentName:"p"},"UserRequired")," qui renvoie une erreur 401 ou redirige l'utilisateur si celui-ci n'est pas connect\xe9. "),Object(s.b)("p",null,"Mettez \xe0 jour ",Object(s.b)("inlineCode",{parentName:"p"},"app.controller.ts"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, controller, Get, IAppController, render, Session, UserRequired, UseSessions } from '@foal/core';\n\nimport { ApiController, AuthController } from './controllers';\n\n// ...\nexport class AppController extends IAppController {\n\n  // ...\n\n  @Get('/')\n  @UserRequired({\n    // Redirect to /signin if the user is not authenticated.\n    redirectTo: '/signin'\n  })\n  index() {\n    // ...\n  }\n\n  // ...\n\n}\n")),Object(s.b)("p",null,"Mettez \xe0 jour ",Object(s.b)("inlineCode",{parentName:"p"},"api.controller.ts"),"."),Object(s.b)("pre",null,Object(s.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"import {\n  Context, Delete, Get, HttpResponseCreated, HttpResponseNoContent,\n  HttpResponseNotFound, HttpResponseOK, Post,\n  UserRequired, ValidateBody, ValidatePathParam\n} from '@foal/core';\n\nimport { Todo, User } from '../entities';\n\n@UserRequired()\nexport class ApiController {\n\n  ...\n\n}\n")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"Lorsqu'un hook d\xe9core une classe de contr\xf4leur, il s'applique \xe0 toutes les routes du contr\xf4leur et de ses sous-contr\xf4leurs.")),Object(s.b)("p",null,"Allez sur ",Object(s.b)("inlineCode",{parentName:"p"},"http://localhost:3001"),". Si vous n'\xeates pas connect\xe9, vous devriez \xeatre redirig\xe9 vers la page de connexion."))}u.isMDXComponent=!0},290:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),o=n.n(r);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),u=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=u(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},b=o.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(n),b=r,m=p["".concat(i,".").concat(b)]||p[b]||d[b]||s;return n?o.a.createElement(m,a(a({ref:t},c),{},{components:n})):o.a.createElement(m,a({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=b;var a={};for(var l in t)hasOwnProperty.call(t,l)&&(a[l]=t[l]);a.originalType=e,a.mdxType="string"==typeof e?e:r,i[1]=a;for(var c=2;c<s;c++)i[c]=n[c];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"}}]);
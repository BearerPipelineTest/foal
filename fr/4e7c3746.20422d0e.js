(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{140:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return p}));var r=n(3),o=n(7),a=(n(0),n(271)),s={title:"Les Scripts Shell"},i={unversionedId:"tutorials/multi-user-todo-list/3-the-shell-scripts",id:"tutorials/multi-user-todo-list/3-the-shell-scripts",isDocsHomePage:!1,title:"Les Scripts Shell",description:"Comme dans le tutoriel pr\xe9c\xe9dent, vous allez utiliser des scripts shell pour alimenter la base de donn\xe9es.",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/3-the-shell-scripts.md",slug:"/tutorials/multi-user-todo-list/3-the-shell-scripts",permalink:"/fr/docs/tutorials/multi-user-todo-list/3-the-shell-scripts",editUrl:"https://github.com/FoalTS/foal/edit/master/docs/i18n/fr/docusaurus-plugin-content-docs/current/tutorials/multi-user-todo-list/3-the-shell-scripts.md",version:"current",sidebar:"someSidebar",previous:{title:"Les Mod\xe8les User & Todo",permalink:"/fr/docs/tutorials/multi-user-todo-list/2-the-user-and-todo-models"},next:{title:"Contr\xf4leurs & Hooks d'Authentification",permalink:"/fr/docs/tutorials/multi-user-todo-list/5-auth-controllers-and-hooks"}},l=[{value:"Le script <code>create-user</code>",id:"le-script-create-user",children:[]},{value:"Le script <code>create-todo</code>",id:"le-script-create-todo",children:[]}],c={toc:l};function p(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Comme dans le tutoriel pr\xe9c\xe9dent, vous allez utiliser des scripts shell pour alimenter la base de donn\xe9es."),Object(a.b)("h2",{id:"le-script-create-user"},"Le script ",Object(a.b)("inlineCode",{parentName:"h2"},"create-user")),Object(a.b)("p",null,"Un script appel\xe9 ",Object(a.b)("inlineCode",{parentName:"p"},"create-user")," existe d\xe9j\xe0 dans le r\xe9pertoire ",Object(a.b)("inlineCode",{parentName:"p"},"scripts/"),". Il comporte de nombreuses lignes comment\xe9es qui vous permettent de cr\xe9er des utilisateurs avec des ",Object(a.b)("em",{parentName:"p"},"permissions")," et des ",Object(a.b)("em",{parentName:"p"},"groupes"),"."),Object(a.b)("p",null,"Ouvrez le fichier et remplacez son contenu par ce qui suit :"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"// 3p\nimport { isCommon } from '@foal/password';\nimport { createConnection } from 'typeorm';\n\n// App\nimport { User } from '../app/entities';\n\nexport const schema = {\n  additionalProperties: false,\n  properties: {\n    email: { type: 'string', format: 'email' },\n    password: { type: 'string' },\n  },\n  required: [ 'email', 'password' ],\n  type: 'object',\n};\n\nexport async function main(args: { email: string; password: string }) {\n  const connection = await createConnection();\n  try {\n    const user = new User();\n    user.email = args.email;\n\n    if (await isCommon(args.password)) {\n      console.log('This password is too common. Please choose another one.');\n      return;\n    }\n    await user.setPassword(args.password);\n\n    console.log(await user.save());\n  } catch (error) {\n    console.log(error.message);\n  } finally {\n    await connection.close();\n  }\n}\n\n")),Object(a.b)("p",null,"Certaines parties de ce code devraient vous sembler famili\xe8res."),Object(a.b)("p",null,"L'objet ",Object(a.b)("inlineCode",{parentName:"p"},"schema")," est utilis\xe9 pour valider les arguments tap\xe9s dans la ligne de commande. Dans ce cas, le script d\xe9finit deux param\xe8tres obligatoires : une adresse email et un mot de passe. La propri\xe9t\xe9 ",Object(a.b)("inlineCode",{parentName:"p"},"format")," v\xe9rifie que la cha\xeene ",Object(a.b)("inlineCode",{parentName:"p"},"email")," est bien une adresse valide (pr\xe9sence du caract\xe8re ",Object(a.b)("inlineCode",{parentName:"p"},"@"),", etc). "),Object(a.b)("p",null,"La fonction ",Object(a.b)("inlineCode",{parentName:"p"},"main")," est divis\xe9e en plusieurs parties. Tout d'abord, elle instancie une connexion \xe0 la base de donn\xe9es. Ensuite, elle cr\xe9e un nouvel utilisateur avec les arguments sp\xe9cifi\xe9s dans la ligne de commande. La fonction ",Object(a.b)("inlineCode",{parentName:"p"},"isCommon")," compare le mot de passe donn\xe9 avec une liste de dix mille mots de passe courants (ex : ",Object(a.b)("inlineCode",{parentName:"p"},"123456"),", ",Object(a.b)("inlineCode",{parentName:"p"},"password"),", etc). Elle retourne vrai si le mot de passe est trouv\xe9 dans la liste. Enfin, l'utilisateur est enregistr\xe9 dans la base de donn\xe9es et, si une erreur est lev\xe9e, le message d'erreur est affich\xe9."),Object(a.b)("p",null,"Comme vous l'avez peut-\xeatre remarqu\xe9, l'utilitaire ",Object(a.b)("inlineCode",{parentName:"p"},"isCommon")," provient du paquet ",Object(a.b)("inlineCode",{parentName:"p"},"@foal/password"),". Vous devez l'installer."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"npm install @foal/password\n")),Object(a.b)("p",null,"Maintenant, construisez le script."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"npm run build\n")),Object(a.b)("p",null,"Cr\xe9ez deux nouveaux utilisateurs."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),'foal run create-user email="john@foalts.org" password="john_password"\nfoal run create-user email="mary@foalts.org" password="mary_password"\n')),Object(a.b)("blockquote",null,Object(a.b)("p",{parentName:"blockquote"},"Si vous essayez de relancer l'une de ces commandes, vous obtiendrez l'erreur ci-dessous car la cl\xe9 email est unique."),Object(a.b)("p",{parentName:"blockquote"},Object(a.b)("inlineCode",{parentName:"p"},"SQLITE_CONSTRAINT: UNIQUE constraint failed: user.email"))),Object(a.b)("h2",{id:"le-script-create-todo"},"Le script ",Object(a.b)("inlineCode",{parentName:"h2"},"create-todo")),Object(a.b)("p",null,"Le script ",Object(a.b)("inlineCode",{parentName:"p"},"create-todo")," est un peu plus complexe car ",Object(a.b)("inlineCode",{parentName:"p"},"Todo")," a une relation ",Object(a.b)("em",{parentName:"p"},"many-to-one")," avec ",Object(a.b)("inlineCode",{parentName:"p"},"User"),"."),Object(a.b)("p",null,"Ouvrez le fichier ",Object(a.b)("inlineCode",{parentName:"p"},"create-todo.ts")," et remplacez son contenu."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-typescript"}),"// 3p\nimport { createConnection } from 'typeorm';\n\n// App\nimport { Todo, User } from '../app/entities';\n\nexport const schema = {\n  properties: {\n    owner: { type: 'string', format: 'email' },\n    text: { type: 'string' },\n  },\n  required: [ 'owner', 'text' ],\n  type: 'object',\n};\n\nexport async function main(args: { owner: string; text: string }) {\n  const connection = await createConnection();\n  try {\n    const user = await User.findOne({ email: args.owner });\n\n    if (!user) {\n      console.log('No user was found with the email ' + args.owner);\n      return;\n    }\n\n    const todo = new Todo();\n    todo.text = args.text;\n    todo.owner = user;\n\n    console.log(await todo.save());\n  } catch (error) {\n    console.log(error.message);\n  } finally {\n    await connection.close();\n  }\n}\n\n")),Object(a.b)("p",null,"Nous avons ajout\xe9 un param\xe8tre ",Object(a.b)("inlineCode",{parentName:"p"},"owner")," pour savoir \xe0 quel utilisateur appartient le todo. Il attend l'email de l'utilisateur."),Object(a.b)("p",null,"La fonction ",Object(a.b)("inlineCode",{parentName:"p"},"main")," essaie ensuite de trouver l'utilisateur qui a cette adresse email. S'il n'existe pas, le script se termine par un message affich\xe9 dans la console. Sinon, l'utilisateur est ajout\xe9 au todo comme propri\xe9taire."),Object(a.b)("p",null,"Construisez le script."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),"npm run build\n")),Object(a.b)("p",null,"Cr\xe9ez de nouveaux todos pour chaque utilisateur."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{}),'foal run create-todo owner="john@foalts.org" text="John task 1"\nfoal run create-todo owner="john@foalts.org" text="John task 2"\nfoal run create-todo owner="mary@foalts.org" text="Mary task 1"\nfoal run create-todo owner="mary@foalts.org" text="Mary task 2"\n')))}p.isMDXComponent=!0},271:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),p=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},m=o.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=r,b=u["".concat(s,".").concat(m)]||u[m]||d[m]||a;return n?o.a.createElement(b,i(i({ref:t},c),{},{components:n})):o.a.createElement(b,i({ref:t},c))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,s=new Array(a);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return o.a.createElement.apply(null,s)}return o.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);
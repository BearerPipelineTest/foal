(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{160:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return i})),a.d(t,"metadata",(function(){return l})),a.d(t,"toc",(function(){return c})),a.d(t,"default",(function(){return p}));var n=a(3),r=a(7),o=(a(0),a(283)),i={title:"Image Upload and Download"},l={unversionedId:"tutorials/real-world-example-with-react/12-file-upload",id:"tutorials/real-world-example-with-react/12-file-upload",isDocsHomePage:!1,title:"Image Upload and Download",description:"The next step in this tutorial is to allow users to upload a profile picture. This image will be displayed on the homepage in front of each author's story.",source:"@site/docs/tutorials/real-world-example-with-react/12-file-upload.md",slug:"/tutorials/real-world-example-with-react/12-file-upload",permalink:"/docs/tutorials/real-world-example-with-react/12-file-upload",editUrl:"https://github.com/FoalTS/foal/edit/master/docs/docs/tutorials/real-world-example-with-react/12-file-upload.md",version:"current",sidebar:"someSidebar",previous:{title:"Adding Sign Up",permalink:"/docs/tutorials/real-world-example-with-react/11-sign-up"},next:{title:"CSRF Protection",permalink:"/docs/tutorials/real-world-example-with-react/13-csrf"}},c=[{value:"Server Side",id:"server-side",children:[]},{value:"Client Side",id:"client-side",children:[]}],s={toc:c};function p(e){var t=e.components,i=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},s,i,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The next step in this tutorial is to allow users to upload a profile picture. This image will be displayed on the homepage in front of each author's story."),Object(o.b)("p",null,"To do this, you will use Foal's storage system. It allows you to validate and save the files uploaded by the client. These files can be saved to your local drive or in the cloud using AWS S3. We won't use the cloud feature in this tutorial, but you can find out how to configure it ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/file-system/local-and-cloud-storage"}),"here"),"."),Object(o.b)("h2",{id:"server-side"},"Server Side"),Object(o.b)("p",null,"First, install the package. "),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"npm install @foal/storage\n")),Object(o.b)("p",null,"Update the configuration in ",Object(o.b)("inlineCode",{parentName:"p"},"config/default.json")," to specify the location of files that the disk manager can access."),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),'{\n  "port": "env(PORT)",\n  "settings": {\n    ...\n    "disk": {\n      "local": {\n        "directory": "assets"\n      }\n    }\n  },\n  ...\n}\n')),Object(o.b)("p",null,"Then create the directory ",Object(o.b)("inlineCode",{parentName:"p"},"assets/images/profiles/uploaded")," where the profile images will be uploaded. Download the default profile image ",Object(o.b)("a",{target:"_blank",href:a(396).default},"here")," and place it in the ",Object(o.b)("inlineCode",{parentName:"p"},"assets/images/profiles")," folder with the name ",Object(o.b)("inlineCode",{parentName:"p"},"default.png"),"."),Object(o.b)("p",null,"You are ready to create the controller. Generate a new one."),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"foal generate controller api/profile --register\n")),Object(o.b)("p",null,"Open the new file and add two new routes."),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"API endpoint"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Method"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"/api/profile/avatar")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"GET")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Retrieves the user's profile image. If the optional query parameter ",Object(o.b)("inlineCode",{parentName:"td"},"userId")," is provided, the server returns the avatar of that user. Otherwise, it returns the avatar of the current user. If no user is authenticated or has no profile picture, a default image is returned.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"/api/profile")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"POST")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Updates the user profile. A ",Object(o.b)("inlineCode",{parentName:"td"},"name")," field and an optional ",Object(o.b)("inlineCode",{parentName:"td"},"avatar")," file are expected.")))),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript"}),"import { Context, dependency, Get, HttpResponseNoContent, Post, UserRequired, ValidateQueryParam } from '@foal/core';\nimport { File, Disk, ValidateMultipartFormDataBody } from '@foal/storage';\nimport { User } from '../../entities';\n\nexport class ProfileController {\n  @dependency\n  disk: Disk;\n\n  @Get('/avatar')\n  @ValidateQueryParam('userId', { type: 'number' }, { required: false })\n  async readProfileImage(ctx: Context<User|undefined>) {\n    let user = ctx.user;\n\n    const userId: number|undefined = ctx.request.query.userId;\n    if (userId !== undefined) {\n      user = await User.findOne({ id: userId })\n    }\n\n    if (!user || !user.avatar) {\n      return this.disk.createHttpResponse('images/profiles/default.png');\n    }\n\n    return this.disk.createHttpResponse(user.avatar);\n  }\n\n  @Post()\n  @UserRequired()\n  @ValidateMultipartFormDataBody({\n    files: {\n      avatar: { required: false, saveTo: 'images/profiles/uploaded' }\n    },\n    fields: {\n      name: { type: 'string', maxLength: 255 }\n    }\n  })\n  async updateProfileImage(ctx: Context<User>) {\n    ctx.user.name = ctx.request.body.fields.name;\n\n    // Warning: use Foal's File interface\n    const file = ctx.request.body.files.avatar as File|undefined;\n    if (file) {\n      if (ctx.user.avatar) {\n        await this.disk.delete(ctx.user.avatar);\n      }\n      ctx.user.avatar = file.path;\n    }\n\n    await ctx.user.save();\n\n    return new HttpResponseNoContent();\n  }\n\n}\n\n")),Object(o.b)("p",null,"Go to ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"http://localhost:3001/swagger"}),"http://localhost:3001/swagger")," and try to upload a profile picture. You must be logged in first."),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"You may have noticed the ",Object(o.b)("inlineCode",{parentName:"p"},"@dependency")," decorator for setting the ",Object(o.b)("inlineCode",{parentName:"p"},"disk: Disk")," property. This mechanism is called dependency injection and is particularly useful in unit testing. You can read more about it ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/architecture/architecture-overview"}),"here"))),Object(o.b)("h2",{id:"client-side"},"Client Side"),Object(o.b)("p",null,"On the client side, downloading the profile image is handled in the ",Object(o.b)("inlineCode",{parentName:"p"},"ProfileHeader.tsx")," and ",Object(o.b)("inlineCode",{parentName:"p"},"requests/profile.ts")," files."),Object(o.b)("p",null,"Open the latter and implement the ",Object(o.b)("inlineCode",{parentName:"p"},"updateProfile")," function."),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript"}),"import axios from 'axios';\n\nexport async function updateProfile(username: string, avatar: File|null): Promise<void> {\n  const formData = new FormData();\n  formData.set('name', username);\n  if (avatar) {\n    formData.set('avatar', avatar);\n  }\n\n  await axios.post('/api/profile', formData, {\n    headers: {\n    'content-type': 'multipart/form-data'\n    }\n  });\n}\n")),Object(o.b)("p",null,"Now, if you go back to ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"http://localhost:3000/profile"}),"http://localhost:3000/profile"),", you should be able to upload your profile picture."))}p.isMDXComponent=!0},283:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return f}));var n=a(0),r=a.n(n);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=r.a.createContext({}),p=function(e){var t=r.a.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},d=function(e){var t=p(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=p(a),b=n,f=d["".concat(i,".").concat(b)]||d[b]||u[b]||o;return a?r.a.createElement(f,l(l({ref:t},s),{},{components:a})):r.a.createElement(f,l({ref:t},s))}));function f(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=b;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var s=2;s<o;s++)i[s]=a[s];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"},396:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/files/default-9490f4915bf9aca8c77fd98e411f2e2c.png"}}]);